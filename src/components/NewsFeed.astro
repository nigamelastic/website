---
import NewsCard from './NewsCard.astro';
import Parser from 'rss-parser';
import { sanitizeUrl } from '../utils/security';

type NewsItem = {
  title: string;
  link: string;
  pubDate: string;
  contentSnippet: string;
  source: string;
  isoDate?: string;
};

const parser = new Parser();

import { FEEDS } from '../data/news-feeds';

let news: NewsItem[] = [];

try {
  const feedPromises = FEEDS.map(async (feed) => {
    try {
      const parsed = await parser.parseURL(feed.url);
      return parsed.items.map((item) => ({
        title: item.title || 'No Title',
        link: sanitizeUrl(item.link || '#'),
        pubDate: item.pubDate || '',
        contentSnippet: item.contentSnippet || '',
        source: feed.name,
        isoDate: item.isoDate,
      }));
    } catch (error) {
      console.error(`Error fetching feed ${feed.name}:`, error);
      return [];
    }
  });

  const results = await Promise.all(feedPromises);
  const flattenedResults = results.flat() as NewsItem[];

  // Sort by date (newest first)
  const sortedNews = flattenedResults.sort((a, b) => {
    const dateA = new Date(a.isoDate || a.pubDate || 0);
    const dateB = new Date(b.isoDate || b.pubDate || 0);
    return dateB.getTime() - dateA.getTime();
  });

  // Limit to latest 30 items
  news = sortedNews.slice(0, 30);
} catch (error) {
  console.error('Failed to fetch news feeds:', error);
}
---

<div class="not-prose my-12">
  {news.map((item: NewsItem, index: number) => (
    <>
      {index > 0 && (
        <div style="margin: 3rem 0;">
          <div style="height: 2px; background: linear-gradient(to right, transparent, rgb(139, 92, 246), transparent);"></div>
        </div>
      )}
      <NewsCard {...item} />
    </>
  ))}
  
  {news.length === 0 && (
    <div class="text-center py-20 bg-violet-50 dark:bg-violet-950/30 rounded-2xl border-2 border-dashed border-violet-300 dark:border-violet-700">
      <p class="text-slate-600 dark:text-slate-400 text-lg">No news updates found at the moment. Please check back later.</p>
    </div>
  )}
</div>
