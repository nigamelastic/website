---
import NewsCard from './NewsCard.astro';
import Parser from 'rss-parser';

type NewsItem = {
  title: string;
  link: string;
  pubDate: string;
  contentSnippet: string;
  source: string;
  isoDate?: string;
  timestamp?: number;
};

const parser = new Parser();

import { FEEDS } from '../data/news-feeds';

let news: NewsItem[] = [];

try {
  const feedPromises = FEEDS.map(async (feed) => {
    try {
      const parsed = await parser.parseURL(feed.url);
      return parsed.items.map((item) => {
        const fullSnippet = item.contentSnippet || '';
        const MAX_SNIPPET_LENGTH = 350;
        const truncatedSnippet =
          fullSnippet.length > MAX_SNIPPET_LENGTH
            ? fullSnippet.slice(0, MAX_SNIPPET_LENGTH) + '...'
            : fullSnippet;

        return {
          title: item.title || 'No Title',
          link: item.link || '#',
          pubDate: item.pubDate || '',
          contentSnippet: truncatedSnippet,
          source: feed.name,
          isoDate: item.isoDate,
          timestamp: new Date(item.isoDate || item.pubDate || 0).getTime(),
        };
      });
    } catch (error) {
      console.error(`Error fetching feed ${feed.name}:`, error);
      return [];
    }
  });

  const results = await Promise.all(feedPromises);
  const flattenedResults = results.flat() as NewsItem[];

  // Sort by date (newest first)
  const sortedNews = flattenedResults.sort((a, b) => {
    return (b.timestamp || 0) - (a.timestamp || 0);
  });

  // Limit to latest 30 items
  news = sortedNews.slice(0, 30);
} catch (error) {
  console.error('Failed to fetch news feeds:', error);
}
---

<div class="not-prose my-12">
  {news.map((item: NewsItem, index: number) => (
    <>
      {index > 0 && (
        <div style="margin: 3rem 0;">
          <div style="height: 2px; background: linear-gradient(to right, transparent, rgb(139, 92, 246), transparent);"></div>
        </div>
      )}
      <NewsCard {...item} />
    </>
  ))}
  
  {news.length === 0 && (
    <div class="text-center py-20 bg-violet-50 dark:bg-violet-950/30 rounded-2xl border-2 border-dashed border-violet-300 dark:border-violet-700">
      <p class="text-slate-600 dark:text-slate-400 text-lg">No news updates found at the moment. Please check back later.</p>
    </div>
  )}
</div>
